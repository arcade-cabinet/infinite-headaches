# Gameplay Mechanics E2E Test
# Tests actual game mechanics with AutoPlayer to verify real behavior
#
# VERIFIES:
# 1. Score ACTUALLY increases when animals are caught
# 2. Stack height ACTUALLY changes during gameplay
# 3. Bank button appears when stack reaches threshold
# 4. Banking works and resets stack
# 5. Level progression occurs
#
# This test WILL FAIL if:
# - Score stays at 0 during gameplay
# - Stack never increases
# - Bank button never appears with 5+ animals
# - Game mechanics are broken

appId: web
---
# ============================================================
# SETUP: Get to gameplay quickly
# ============================================================

- openLink: https://homestead-headaches.netlify.app

# Skip splash if present
- evalScript: ${sessionStorage.setItem('homestead_splash_shown_session', 'true')}
- evalScript: ${window.location.reload()}

- extendedWaitUntil:
    visible: "NEW GAME"
    timeout: 15000

# Start game
- tapOn: "NEW GAME"

- extendedWaitUntil:
    visible: "SELECT MODE"
    timeout: 5000

# Select Endless mode
- evalScript: |
    ${
      const modeCards = document.querySelectorAll('button');
      const endlessCard = Array.from(modeCards).find(b =>
        b.textContent && b.textContent.includes('Endless') && !b.disabled
      );
      if (endlessCard) endlessCard.click();
    }

- extendedWaitUntil:
    visible: "CHOOSE YOUR HAND"
    timeout: 5000

- tapOn: "SELECT"

# Handle tutorial
- extendedWaitUntil:
    visible: "STACK|Got it"
    timeout: 10000

- evalScript: ${output.tutorialBtn = document.body.textContent.includes('Got it')}
- runFlow:
    when:
      true: ${output.tutorialBtn == true}
    commands:
      - tapOn: "Got it"
      - waitForAnimationToEnd

- extendedWaitUntil:
    visible: "STACK"
    timeout: 5000

# ============================================================
# TEST 1: Capture initial game state
# ============================================================

- takeScreenshot: mechanics-01-initial-state

# Capture initial score (should be 0 or low)
- evalScript: |
    ${
      // Find score element - it's the large number in top left
      const scoreText = document.body.textContent.match(/(\d{1,3}(,\d{3})*|\d+)/);
      output.initialScore = scoreText ? parseInt(scoreText[0].replace(/,/g, '')) : 0;
      console.log('Initial score captured:', output.initialScore);
    }

# Capture initial stack height
- evalScript: |
    ${
      const stackMatch = document.body.textContent.match(/STACK:\s*(\d+)/);
      output.initialStack = stackMatch ? parseInt(stackMatch[1]) : 0;
      console.log('Initial stack:', output.initialStack);
    }

# ============================================================
# TEST 2: Enable AutoPlayer and verify score increases
# ============================================================

# Enable AutoPlayer
- evalScript: ${window.__enableAutoPlayer && window.__enableAutoPlayer()}

# Play for 10 seconds
- repeat:
    times: 10
    commands:
      - waitForAnimationToEnd

- takeScreenshot: mechanics-02-after-10-seconds

# Capture score after 10 seconds
- evalScript: |
    ${
      // Get all text content and look for number patterns
      const allNumbers = document.body.textContent.match(/\d{1,}/g) || [];
      // The score should be a larger number now - look for any number > 10
      const possibleScores = allNumbers.map(n => parseInt(n)).filter(n => n > 10);
      output.scoreAfter10Sec = possibleScores.length > 0 ? Math.max(...possibleScores) : 0;
      console.log('Score after 10 seconds:', output.scoreAfter10Sec);
    }

# VERIFY: Score should have increased
- evalScript: |
    ${
      output.scoreIncreased = output.scoreAfter10Sec > output.initialScore;
      console.log('Score increased:', output.scoreIncreased, 'from', output.initialScore, 'to', output.scoreAfter10Sec);
    }

# ============================================================
# TEST 3: Verify stack mechanics
# ============================================================

# Check if stack has changed
- evalScript: |
    ${
      const stackMatch = document.body.textContent.match(/STACK:\s*(\d+)/);
      output.stackAfter10Sec = stackMatch ? parseInt(stackMatch[1]) : 0;
      console.log('Stack after 10 seconds:', output.stackAfter10Sec);
    }

# Play more to build up stack
- repeat:
    times: 15
    commands:
      - waitForAnimationToEnd

- takeScreenshot: mechanics-03-after-25-seconds

# Check stack height again
- evalScript: |
    ${
      const stackMatch = document.body.textContent.match(/STACK:\s*(\d+)/);
      output.currentStack = stackMatch ? parseInt(stackMatch[1]) : 0;
      console.log('Current stack height:', output.currentStack);
    }

# ============================================================
# TEST 4: Bank button verification
# ============================================================

# Check if bank button is visible (appears when stack >= 5)
# The bank button has aria-label like "Bank X ducks"
- evalScript: |
    ${
      const bankButton = document.querySelector('[aria-label*="Bank"]');
      output.bankButtonVisible = bankButton !== null &&
        window.getComputedStyle(bankButton).opacity !== '0';
      output.bankButtonLabel = bankButton ? bankButton.getAttribute('aria-label') : 'not found';
      console.log('Bank button:', output.bankButtonLabel, 'visible:', output.bankButtonVisible);
    }

# If bank button is visible, test banking
- runFlow:
    when:
      true: ${output.bankButtonVisible == true}
    commands:
      - takeScreenshot: mechanics-04-bank-button-visible
      # Capture stack before banking
      - evalScript: |
          ${
            const stackMatch = document.body.textContent.match(/STACK:\s*(\d+)/);
            output.stackBeforeBank = stackMatch ? parseInt(stackMatch[1]) : 0;
          }
      # Click the bank button
      - tapOn:
          id: .*Bank.*
      - waitForAnimationToEnd
      - waitForAnimationToEnd
      # Verify stack reset
      - evalScript: |
          ${
            const stackMatch = document.body.textContent.match(/STACK:\s*(\d+)/);
            output.stackAfterBank = stackMatch ? parseInt(stackMatch[1]) : 0;
            output.bankWorked = output.stackAfterBank < output.stackBeforeBank;
            console.log('Stack before bank:', output.stackBeforeBank, 'after:', output.stackAfterBank);
          }
      - takeScreenshot: mechanics-05-after-banking

# ============================================================
# TEST 5: Level progression verification
# ============================================================

# Play more to try to level up
- repeat:
    times: 20
    commands:
      - waitForAnimationToEnd

- takeScreenshot: mechanics-06-longer-gameplay

# Capture final game state
- evalScript: |
    ${
      // Get level
      const lvMatch = document.body.textContent.match(/LV\.?\s*(\d+)/);
      output.currentLevel = lvMatch ? parseInt(lvMatch[1]) : 1;

      // Check if game is still running (not game over)
      output.gameStillRunning = document.body.textContent.includes('STACK') ||
        document.body.textContent.includes('LV');

      // Check for game over
      output.gameOver = document.body.textContent.includes('GAME OVER');

      console.log('Level:', output.currentLevel, 'Running:', output.gameStillRunning, 'GameOver:', output.gameOver);
    }

# ============================================================
# CLEANUP
# ============================================================

# Disable AutoPlayer
- evalScript: ${window.__disableAutoPlayer && window.__disableAutoPlayer()}

- takeScreenshot: mechanics-07-final-state

# ============================================================
# FINAL ASSERTIONS
# ============================================================

# At minimum, verify the game ran without crashing
- assertVisible: "STACK|LV|GAME OVER"

# Log summary
- evalScript: |
    ${
      console.log('=== GAMEPLAY MECHANICS TEST SUMMARY ===');
      console.log('Initial Score:', output.initialScore || 0);
      console.log('Score after 10s:', output.scoreAfter10Sec || 0);
      console.log('Score Increased:', output.scoreIncreased || false);
      console.log('Stack Height Observed:', output.currentStack || 0);
      console.log('Bank Button Appeared:', output.bankButtonVisible || false);
      console.log('Current Level:', output.currentLevel || 1);
      console.log('Game Still Running:', output.gameStillRunning || false);
      console.log('Game Over Screen:', output.gameOver || false);
      console.log('========================================');
    }
